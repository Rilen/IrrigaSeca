<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IrrigaSeca</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<style>
  body{font:14px Arial;margin:0;background:#f5f5f5}
  #c{padding:10px;max-width:1200px;margin:auto}
  h2{text-align:center;margin:10px 0}
  .menu{display:flex;flex-direction:column;gap:15px;align-items:center}
  .menu div{width:100%;max-width:300px}
  
  canvas#graf{background:#fff;border-radius:8px;box-shadow:0 2px 8px #0002;height:280px;width:100%}
  #pred{margin-top:30px;padding-top:20px;border-top:2px solid #eee}
  .blc{background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;margin:10px 0}
  .tbl{width:100%;border-collapse:collapse}
  .tbl td{padding:8px;border-bottom:1px solid #eee}
  .tbl td:last-child{text-align:right;font-weight:bold}
  .alto{color:#d9534f}.medio{color:#f0ad4e}.baixo{color:#5cb85c}
  #map{height:320px;width:90vw;max-width:900px;margin:15px auto;border-radius:12px;border:1px solid #ccc}
  @keyframes fade{0%{opacity:0;transform:translate(-50%,20px)}20%{opacity:1;transform:translate(-50%,0)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-20px)}}
  @media(min-width:768px){
    .menu{flex-direction:row;justify-content:center;flex-wrap:wrap}
    canvas#graf{height:450px}
    #map{height:420px}
    .blc{max-width:45%;display:inline-block;vertical-align:top;text-align:center}
  }
</style>
</head>
<body>
<div id="c">
  <h2>Análise de Umidade - IrrigaSeca</h2>
  <div id="pred" class="menu">
    <div><label>Ano:<select id="a"></select></label></div>
    <div><label>Mês:<select id="m"></select></label></div> 
    <div><label>Período:<select id="p">
      <option value="24h">24h</option><option value="7d">7d</option>
      <option value="15d">15d</option><option value="30d">30d</option>
      <option value="60d">60d</option><option value="90d">90d</option>
      <option value="all" selected>Tudo</option>
    </select></label></div>
    
    </div>
	</br>
  <canvas id="graf"></canvas>

  <div id="pred">
    <h2>Análise Preditiva</h2>
    <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center">
      <div class="blc"><h3>Próximas 12h</h3>
        <table class="tbl" id="tbl"></table>
      </div>
      <div class="blc"><h3>Mapa de Calor</h3>
        <div id="map"></div>
      </div>
    </div>
  </div>
</div>

<script>
const files=["fileiraA","fileiraB","fileiraC","fileiraD"];
const cores=['#00f','#f00','#0f0','#fa0'];
const MAX=500; let chart=null,th=0;
const cache={};

const a=document.getElementById('a'),m=document.getElementById('m'),p=document.getElementById('p');
const ctx=document.getElementById('graf').getContext('2d');


// Variáveis de data e inicialização do menu de data/ano
const meses = ['janeiro', 'fevereiro', 'marco', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
const hoje = new Date();
const anoAtual = hoje.getFullYear();
const mesAtual = meses[hoje.getMonth()];
const minAno = 2022; 
const maxAno = 2027; 

for(let y = minAno; y <= maxAno; y++){
  let o = document.createElement('option');
  o.value = y;
  o.text = y;
  if (y === anoAtual) { o.selected = true; }
  a.appendChild(o);
}
meses.forEach(mes => {
    let o = document.createElement('option');
    o.value = mes;
    o.text = mes;
    if (mes === mesAtual) { o.selected = true; }
    m.appendChild(o);
});


function url(f){return `./data/${f}_${m.value}_${a.value}.log`;}
async function load(f){
  const u=url(f); if(cache[u])return cache[u];
  try{
    const r=await fetch(u);
    if(!r.ok)return {l:[],d:[]};
    const t=await r.text();
    const linhas=t.trim().split('\n');
    const l=[],d=[];
    linhas.forEach(x=>{const v=x.split(';');if(v[0].startsWith('202')){l.push(v[0]);d.push(+v[1]);}});
    return cache[u]={l,d};
  }catch(e){return {l:[],d:[]};}
}

function range(len,per){
  if(per==='24h')return [Math.max(0,len-24),len];
  if(per==='7d')return [Math.max(0,len-168),len];
  if(per==='15d')return [Math.max(0,len-360),len];
  if(per==='30d')return [Math.max(0,len-720),len];
  if(per==='60d')return [Math.max(0,len-1440),len];
  if(per==='90d')return [Math.max(0,len-2160),len];
  return [0,len];
}

const upd=()=>{
  if(th)return; th=1;
  setTimeout(async()=>{
    // Simplificado: Todas as fileiras são carregadas por padrão (o controle de visibilidade é da legenda do Chart.js)
    const sel = files; 

    let L=[],DS=[],mx=0,per=p.value;
    for(let f of sel){
      const {l,d}=await load(f);
      if(!l.length)continue;
      const [i,e]=range(l.length,per);
      let ls=l.slice(i,e), ds=d.slice(i,e);
      if(ds.length>MAX)ds=ds.filter((_,k)=>k%Math.ceil(ds.length/MAX)===0);
      if(ls.length>mx){mx=ls.length;L=ls;}
      DS.push({label:f,data:ds,borderColor:cores[files.indexOf(f)],tension:.1,pointRadius:2,fill:false});
    }
    const dias = per==='15d'?15 : per==='30d'?30 : per==='60d'?60 : per==='90d'?90 : per==='7d'?7 : per==='24h'?1 : 999;
    const step = mx>0 ? Math.ceil(mx/(12*dias)) : 1;
    if(chart)chart.destroy();
    chart=new Chart(ctx,{type:'line',data:{labels:L,datasets:DS},options:{
      responsive:true,maintainAspectRatio:true,animation:false,
      plugins:{legend:{display:true}},
      scales:{x:{ticks:{maxTicksLimit:12,stepSize:step}}, y:{min:0,max:100,title:{display:true,text:'%'}}}
    }});
    tbl();map();alertas();th=0;
  },10);
};

const tbl=()=>{
  // HARDCODED: Próxima etapa será dinamizar esta função
  const t=document.getElementById('tbl');
  const r=[{f:'A',c:'baixo'},{f:'B',c:'baixo'},{f:'C',c:'alto'},{f:'D',c:'medio'}];
  t.innerHTML=r.map(x=>`<tr><td>Fileira ${x.f}</td><td class="${x.c}">${x.c.toUpperCase()}</td></tr>`).join('');
};

let mapa=null;
const map=()=>{
  // HARDCODED: Próxima etapa será dinamizar esta função
  if(mapa)mapa.remove();
  mapa=L.map('map').setView([-23.55,-46.63],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
  const h=[[-23.548,-46.635,0.2],[-23.549,-46.630,0.2],[-23.552,-46.632,1],[-23.551,-46.637,0.6]];
  L.heatLayer(h,{radius:25,blur:15,gradient:{0.2:'green',0.6:'yellow',1:'red'}}).addTo(mapa);
};

const alertas=()=>{
  const div=document.createElement('div');
  div.style=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
             background:#222;color:#fff;padding:15px 25px;border-radius:50px;
             box-shadow:0 4px 20px #0008;z-index:999;font-weight:bold;
             animation:fade 4s forwards;`;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),4000);

  const ultimo=[];
  files.forEach(f=>{
    const u=url(f), d=cache[u];
    if(d && d.d.length) ultimo.push({f,fim:d.d[d.d.length-1]}); 
  });
  const secos=ultimo.filter(x=>x.fim<18);
  if(secos.length){
    div.textContent=`⚠️ IRRIGUE JÁ: ${secos.map(x=>x.f.slice(-1)).join(', ')} (${secos[0].fim.toFixed(1)}%)`;
    div.style.background='#d9534f';
  }else{
    div.textContent='✅ Umidade OK em todas fileiras';
    div.style.background='#5cb85c';
  }
};

// Event handlers simplificados para os selects (ano, mês, período)
[a,m,p].forEach(el=>el.onclick=upd);
upd();
</script>
</body>
</html>