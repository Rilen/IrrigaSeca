<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Fileiras - Gráfico Único com Filtros</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    display: flex; justify-content: center;
  }
  #container {
    max-width: 1200px; width: 100%;
  }
  h2 { text-align: center; }
  .menu-container {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 25px;
    flex-wrap: wrap;
  }
  .menu-block {
    text-align: left;
    max-width: 200px;
  }
  .fileira-checkboxes label {
    display: block;
    margin: 4px 0;
    cursor: pointer;
  }
  /* Cores para os checkboxes na label */
  .fileira-checkboxes label input[value="fileiraA"] + span::before {
    content: '';
    display: inline-block;
    width: 14px; height: 14px;
    background: blue;
    margin-right: 6px;
    vertical-align: middle;
  }
  .fileira-checkboxes label input[value="fileiraB"] + span::before {
    content: '';
    display: inline-block;
    width: 14px; height: 14px;
    background: red;
    margin-right: 6px;
    vertical-align: middle;
  }
  .fileira-checkboxes label input[value="fileiraC"] + span::before {
    content: '';
    display: inline-block;
    width: 14px; height: 14px;
    background: green;
    margin-right: 6px;
    vertical-align: middle;
  }
  .fileira-checkboxes label input[value="fileiraD"] + span::before {
    content: '';
    display: inline-block;
    width: 14px; height: 14px;
    background: orange;
    border: 1px solid #aaa;
    margin-right: 6px;
    vertical-align: middle;
  }
  /* Esconde checkbox padrão */
  .fileira-checkboxes input[type="checkbox"] {
    display: none;
  }
  /* Estilo customizado para o checkbox */
  .fileira-checkboxes input[type="checkbox"]:checked + span {
    font-weight: bold;
  }
  
  /* Gráfico de Linha */
  #graficoUnico {
    width: 80vw !important;
    max-width: 80vw !important;
    min-width: 400px;
    height: 450px !important;
    min-height: 450px !important;
    display: block;
    margin: 0 auto 30px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(150,150,150,0.1);
  }
  
  /* Estilos para a seção Preditiva */
  #predictive-analysis {
    border-top: 2px solid #eee;
    margin-top: 40px;
    padding-top: 20px;
  }
  #predictive-container {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 20px;
  }
  .prediction-block {
    flex: 1;
    min-width: 280px;
    max-width: 45%;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
  }
  .prediction-block h3 {
    margin-top: 0;
    text-align: center;
    color: #333;
  }
  .risk-table {
    width: 100%;
    border-collapse: collapse;
  }
  .risk-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #eee;
  }
  .risk-table td:first-child {
    font-weight: bold;
    color: #555;
  }
  .risk-table td:last-child {
    text-align: right;
    font-weight: bold;
  }
  /* Classes de Risco (simuladas) */
  .risk-alto { color: #D9534F; }
  .risk-medio { color: #F0AD4E; }
  .risk-baixo { color: #5CB85C; }

  /* CSS ATUALIZADO PARA O MAPA */
  #risk-map {
    height: 300px; /* Altura do mapa */
    width: 100%;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
</style>
</head>
<body>
<div id="container">
  <h2>Umidade por Fileiras - Gráfico Único</h2>

  <div class="menu-container">
    <div class="menu-block">
      <label for="anoSelect">Ano:</label>
      <select id="anoSelect"></select>
    </div>
    <div class="menu-block">
      <label for="mesSelect">Mês:</label>
      <select id="mesSelect">
        <option value="janeiro">Janeiro</option>
        <option value="fevereiro">Fevereiro</option>
        <option value="marco">Março</option>
        <option value="abril">Abril</option>
        <option value="maio">Maio</option>
        <option value="junho">Junho</option>
        <option value="julho">Julho</option>
        <option value="agosto">Agosto</option>
        <option value="setembro">Setembro</option>
        <option value="outubro">Outubro</option>
        <option value="novembro" selected>Novembro</option>
        <option value="dezembro">Dezembro</option>
      </select>
    </div>
    <div class="menu-block">
      <label for="periodoSelect">Período:</label>
      <select id="periodoSelect">
        <option value="24h">Últimas 24h</option>
        <option value="7d">Última semana</option>
        <option value="15d">Últimos 15 dias</option>
        <option value="all" selected>Todo o mês</option>
      </select>
    </div>
    <div class="menu-block fileira-checkboxes">
      <label><input type="checkbox" value="fileiraA" checked><span>Fileira A</span></label>
      <label><input type="checkbox" value="fileiraB" checked><span>Fileira B</span></label>
      <label><input type="checkbox" value="fileiraC" checked><span>Fileira C</span></label>
      <label><input type="checkbox" value="fileiraD" checked><span>Fileira D</span></label>
    </div>
  </div>

  <canvas id="graficoUnico"></canvas>

  <div id="predictive-analysis">
    <h2 style="text-align: center; margin-bottom: 25px;">Análise Preditiva de Risco</h2>

    <div id="predictive-container">
      
      <div class="prediction-block">
        <h3>Previsão de Risco (Próximas 12h)</h3>
        <p style="text-align: center; font-size: 0.9em; color: #777;">
          Simulação baseada em dados históricos e previsão do tempo (fictícia).
        </p>
        <table class="risk-table" id="risk-forecast-table">
          </table>
      </div>

      <div class="prediction-block">
        <h3>Mapa de Calor Geoespacial</h3>
        <p style="text-align: center; font-size: 0.9em; color: #777;">
          Análise de estresse hídrico interpolada (NDVI + Sensores).
        </p>
        <div id="risk-map"></div>
      </div>

    </div>
  </div>
  </div> <script>
// --- LÓGICA DO GRÁFICO PRINCIPAL ---
const fileirasAll = ["fileiraA", "fileiraB", "fileiraC", "fileiraD"];
const cores = ['blue', 'red', 'green', 'orange'];

const anoSelect = document.getElementById('anoSelect');
const mesSelect = document.getElementById('mesSelect');
const periodoSelect = document.getElementById('periodoSelect');
const graficoUnicoCtx = document.getElementById('graficoUnico').getContext('2d');
const fileiraCheckboxes = document.querySelectorAll('.fileira-checkboxes input[type=checkbox]');

let fileiraCache = {};
let chartInstance = null;

// Popula menu de anos dinamicamente (2022 - 2027)
function popularAnos() {
  const anoInicio = 2022;
  const anoFim = 2027;
  const anoAtual = new Date().getFullYear();
  for(let ano=anoInicio; ano <= anoFim; ano++){
    const option = document.createElement('option');
    option.value = ano;
    option.textContent = ano;
    if(ano === anoAtual) option.selected = true;
    anoSelect.appendChild(option);
  }
}
popularAnos();

// Seleciona automaticamente o mês atual no select
const mesAtualNome = new Date().toLocaleString('pt-BR', { month: 'long'}).toLowerCase();
for(let i = 0; i < mesSelect.options.length; i++) {
  if(mesSelect.options[i].value.toLowerCase() === mesAtualNome) {
    mesSelect.selectedIndex = i;
    break;
  }
}

function getLogUrl(fileira, mes, ano) {
  // Use os arquivos de simulação se eles existirem
  //return `./data/simulacao_${fileira}_${mes}_${ano}.log`; 
  // Ou volte para o original:
  return `./data/${fileira}_${mes}_${ano}.log`;
}

async function fetchLog(fileira, mes, ano) {
  const url = getLogUrl(fileira, mes, ano);
  if(fileiraCache[url]) return fileiraCache[url];
  try {
    const resp = await fetch(url);
    if(!resp.ok) {
      console.warn(`Arquivo não encontrado: ${url}`);
      return {labels: [], umidade: [], eventos: []};
    }
    const text = await resp.text();
    
    // CORREÇÃO: Usar '\n' para quebrar linhas
    const linhas = text.trim().split('\n'); 
    
    let labels = [], umidade = [], eventos = [];
    
    linhas.forEach((linha, i) => {
      const partes = linha.trim().split(';');
      if(partes.length >= 2){
        // Adiciona verificação para garantir que a linha é de dados
        if (partes[0].startsWith('202')) { 
            labels.push(partes[0].trim());
            umidade.push(parseFloat(partes[1]));
            if(partes.length > 2 && partes[2]){
              eventos.push({x: i, status: partes[2].trim()});
            }
        }
      }
    });
    fileiraCache[url] = {labels, umidade, eventos};
    return fileiraCache[url];
  } catch(e) {console.error(e); return {labels: [], umidade: [], eventos: []};}
}

function getPeriodRange(labels, periodo) {
  const total = labels.length;
  if(periodo === '24h') return [Math.max(0, total - 24), total];
  if(periodo === '7d') return [Math.max(0, total - 168), total];
  if(periodo === '15d') return [Math.max(0, total - 360), total];
  return [0, total];
}

async function atualizarGrafico() {
  const mes = mesSelect.value;
  const ano = anoSelect.value;
  const periodo = periodoSelect.value;

  const checkedFileiras = [...fileiraCheckboxes].filter(c=>c.checked).map(c=>c.value);
  if(checkedFileiras.length === 0){
    if(chartInstance){
      chartInstance.destroy();
      chartInstance = null;
    }
    return;
  }

  let dataSets = [];
  let labels = [];
  let maiorLen = 0;

  for(let i=0; i<checkedFileiras.length; i++){
    const fileira = checkedFileiras[i];
    const data = await fetchLog(fileira, mes, ano);
    if(data.labels.length === 0) continue;

    const [inicio, fim] = getPeriodRange(data.labels, periodo);
    const labelsSlice = data.labels.slice(inicio, fim);
    const umidadeSlice = data.umidade.slice(inicio, fim);

    if(labelsSlice.length > maiorLen){
      maiorLen = labelsSlice.length;
      labels = labelsSlice;
    }

    dataSets.push({
      label: fileira,
      data: umidadeSlice,
      borderColor: cores[fileirasAll.indexOf(fileira) % cores.length],
      backgroundColor: cores[fileirasAll.indexOf(fileira) % cores.length],
      fill: false,
      tension: 0.1,
      pointRadius: 2
    });
  }

  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(graficoUnicoCtx, {
    type: 'line',
    data: {labels, datasets: dataSets},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {display: true}
      },
      scales: {
        x: {
          type: 'category',
          title: {display: true, text: 'Data/Hora'},
          
          // ############# INÍCIO DA CORREÇÃO #############
          // O código manual foi removido.
          // Deixamos o Chart.js escolher os melhores rótulos
          // com base no maxTicksLimit.
          ticks: {
            maxTicksLimit: 12
          }
          // ############# FIM DA CORREÇÃO #############
          
        },
        y: {
          min: 0,
          max: 100,
          title: {display: true, text: 'Umidade (%)'}
        }
      }
    }
  });
}

// --- LÓGICA DA TABELA PREDITIVA ---
function popularPrevisao() {
  const tabela = document.getElementById('risk-forecast-table');
  
  // Dados fictícios de previsão
  const previsoes = [
    { fileira: "Fileira A", risco: "Baixo", classe: "risk-baixo" },
    { fileira: "Fileira B", risco: "Baixo", classe: "risk-baixo" },
    { fileira: "Fileira C", risco: "Alto", classe: "risk-alto" },
    { fileira: "Fileira D", risco: "Médio", classe: "risk-medio" }
  ];

  let html = '';
  previsoes.forEach(p => {
    html += `
      <tr>
        <td>${p.fileira}</td>
        <td class="${p.classe}">${p.risco}</td>
      </tr>
    `;
  });
  tabela.innerHTML = html;
}

/* NOVA FUNÇÃO: Inicializar o Mapa de Calor */
function inicializarMapaDeCalor() {
  // Coordenadas fictícias do centro da sua lavoura
  const centroLavoura = [-23.55, -46.63]; 

  // 1. Inicializa o mapa dentro da div 'risk-map'
  const map = L.map('risk-map').setView(centroLavoura, 15); // Nível de zoom 15

  // 2. Adiciona o "chão" do mapa (camada de satélite ou ruas)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // 3. Dados Fictícios (Latitude, Longitude, Intensidade do Risco)
  const dadosRisco = [
    [-23.548, -46.635, 0.2], // Fileira A (Risco Baixo = 0.2)
    [-23.549, -46.630, 0.2], // Fileira B (Risco Baixo = 0.2)
    [-23.552, -46.632, 1.0], // Fileira C (Risco Alto = 1.0)
    [-23.551, -46.637, 0.6]  // Fileira D (Risco Médio = 0.6)
  ];

  // 4. Cria a camada de calor (heatmap)
  L.heatLayer(dadosRisco, {
      radius: 25,
      max: 1.0, // Intensidade máxima (Risco Alto)
      blur: 15,
      gradient: { 0.2: 'green', 0.5: 'yellow', 1.0: 'red' } // Gradiente de cores
  }).addTo(map);
}


// --- INICIALIZAÇÃO ---
anoSelect.addEventListener('change', atualizarGrafico);
mesSelect.addEventListener('change', atualizarGrafico);
periodoSelect.addEventListener('change', atualizarGrafico);
fileiraCheckboxes.forEach(cbx => cbx.addEventListener('change', atualizarGrafico));

// Inicializa gráfico carregando dados
atualizarGrafico();
// Inicializa tabela de previsão
popularPrevisao();
// Inicializa o mapa de calor
inicializarMapaDeCalor();

</script>
</body>
</html>
