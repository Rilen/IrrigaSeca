<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard IrrigaSeca - Relé Único por Horta</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    display: flex;
    justify-content: center;
  }
  #container {
    max-width: 1200px;
    width: 100%;
  }
  h2, h3 {
    text-align: center;
  }
  #configRele {
    background: #f3f3f3;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 20px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
  }
  #statusReleContainer {
    margin-bottom: 20px;
    font-weight: bold;
    font-size: 1.1em;
    text-align: center;
  }
  #periodSelect, #customInputs {
    display: block;
    margin: 0 auto 20px;
    max-width: 300px;
    width: 100%;
    text-align: center;
  }
  #customInputs {
    margin-top: 10px;
  }
  canvas {
    max-width: 100%;
    max-height: 400px;
    display: block;
    margin: 0 auto 40px;
  }
  #mapaRele {
    max-width: 600px;
    margin: 0 auto 40px auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #eee;
  }
</style>
</head>
<body>
<div id="container">
  <h2>Dashboard Monitoramento: Relé Único por Horta</h2>

  <div id="configRele"></div>

  <div id="statusReleContainer">
    <span id="statusReleA"></span> | <span id="statusReleB"></span>
  </div>

  <label for="periodSelect">Selecione o período:</label>
  <select id="periodSelect">
    <option value="24h">Últimas 24 horas</option>
    <option value="7d">Últimos 7 dias (1 semana)</option>
    <option value="15d">Últimos 15 dias</option>
    <option value="1m">Último mês</option>
    <option value="3m">Últimos 3 meses</option>
    <option value="year">Último ano</option>
    <option value="custom">Data Personalizada</option>
  </select>

  <div id="customInputs" style="display:none; margin-top:8px;">
    <label>Data inicial: <input type="datetime-local" id="startDate"></label><br />
    <label>Data final: <input type="datetime-local" id="endDate"></label><br />
    <button onclick="updateCharts()">Atualizar</button>
  </div>

  <h3>Horta A - Umidade do Solo (Gráfico de Barras)</h3>
  <canvas id="hortaAChart"></canvas>

  <h3>Horta B - Umidade do Solo (Gráfico de Barras)</h3>
  <canvas id="hortaBChart"></canvas>

  <div id="mapaRele"></div>
</div>

<script>
  // ATENÇÃO: Se estiver executando este HTML localmente, as URLs do GitHub (abaixo)
  // podem falhar devido a CORS ou problemas de conectividade.
  // Você precisará de um servidor web ou usar os arquivos locais,
  // mas como os logs foram fornecidos no prompt, estou assumindo a leitura de URLs.
  // **A LÓGICA DE PARSING DE DATA E LOG FOI CORRIGIDA ABAIXO**

  const logAUrl = 'https://raw.githubusercontent.com/Rilen/IrrigaSeca/main/data/hortaA.log';
  const logBUrl = 'https://raw.githubusercontent.com/Rilen/IrrigaSeca/main/data/hortaB.log';
  const releConfigUrl = 'https://raw.githubusercontent.com/Rilen/IrrigaSeca/main/data/config_rele.json';
  const mapaReleUrl = 'https://raw.githubusercontent.com/Rilen/IrrigaSeca/main/data/mapa_rele.json';

  const sensoresA = ['S1','S2','S3','S4','S5','S6','S7','S8'];
  const sensoresB = ['S9','S10','S11','S12','S13','S14','S15','S16'];

  let chartA, chartB;
  let dataA = null;
  let dataB = null;
  let configRele = null;

  // CORREÇÃO: Função para analisar corretamente o formato de data/hora "YYYY-MM-DD HH:MM:SS"
  function parseDateTime(str) {
    // 2025-06-16 00:00:00
    const [datePart, timePart] = str.split(' ');
    const [year, month, day] = datePart.split('-');
    const [hour, minute, second] = timePart.split(':');
    // Mês em JavaScript é 0-indexado (Janeiro = 0, Dezembro = 11)
    return new Date(year, month - 1, day, hour, minute, second);
  }

  // CORREÇÃO: Lógica de fetch e parsing de log melhorada
  async function fetchLogData(logUrl) {
    try {
        const resp = await fetch(logUrl);
        if (!resp.ok) {
            console.error(`Falha ao carregar log de ${logUrl}: ${resp.status} - Verifique a URL ou permissões de CORS.`);
            return [];
        }
        const text = await resp.text();
        const linhas = text.trim().split('\n');
        const entries = [];
        
        // logs hortaA e hortaB tem 8 sensores, totalizando 9 partes (data + 8 valores)
        const minPartes = 9; 

        linhas.forEach(linha => {
            // A linha de log real deve ser 'YYYY-MM-DD HH:MM:SS;V1;V2;...;V8'
            // O é do seu prompt, precisa ser removido se estiver nos logs reais
            const cleanLine = linha.replace(/^\/, '').trim();
            const partes = cleanLine.split(';');

            if (partes.length >= minPartes) {
                const dt = parseDateTime(partes[0].trim());
                // Mapear apenas os 8 valores de umidade
                const valores = partes.slice(1, minPartes).map(v => parseFloat(v));
                
                // Garantir que todos os 8 valores são números
                if (valores.length === 8 && valores.every(v => !isNaN(v))) {
                    entries.push({ dt, valores });
                }
            }
        });
        return entries;
    } catch (error) {
        console.error(`Erro durante o fetch ou parsing do log em ${logUrl}:`, error);
        return [];
    }
  }

  // O restante do código JS permanece o mesmo, mas a correção de data/hora era crítica.
  
  function filterEntries(entries, startDate, endDate) {
    return entries.filter(e => e.dt >= startDate && e.dt <= endDate);
  }

  function formatLabels(entries) {
    return entries.map(e => e.dt.toISOString().slice(0,16).replace('T', ' '));
  }

  function prepareDatasets(entries) {
    const nSensores = 8;
    const datasets = Array.from({ length: nSensores }, () => []);
    entries.forEach(e => {
      for(let i = 0; i < nSensores; i++) {
        datasets[i].push(e.valores[i]);
      }
    });
    return datasets;
  }

  function desenharGraficoBarra(idCanvas, labels, datasets, sensores) {
    const cores = ['blue','red','green','orange','purple','teal','gray','brown'];
    const dataSets = datasets.map((data,i) => ({
      label: sensores[i],
      data,
      backgroundColor: cores[i % cores.length],
    }));
    const ctx = document.getElementById(idCanvas).getContext('2d');
    if(idCanvas === 'hortaAChart' && chartA) chartA.destroy();
    if(idCanvas === 'hortaBChart' && chartB) chartB.destroy();
    const newChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: dataSets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: false, title: { display: true, text: 'Data/Hora' } },
          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Umidade (%)' } }
        },
        plugins: { legend: { display: true } }
      }
    });
    if(idCanvas === 'hortaAChart') chartA = newChart;
    if(idCanvas === 'hortaBChart') chartB = newChart;
  }

  async function fetchReleConfig() {
    try {
        const resp = await fetch(releConfigUrl);
        configRele = await resp.json();
        document.getElementById('configRele').innerHTML =
          `Configuração Relê: Ativa <b>abaixo de ${configRele.umidade_ativacao}%</b> de umidade.<br>` +
          `Relê permanece acionado por <b>${configRele.tempo_aberto_segundos} segundos</b>.`;
    } catch (error) {
        console.error("Erro ao carregar configuração do relé:", error);
        document.getElementById('configRele').innerHTML = "Configuração do relé não carregada.";
    }
  }

  async function fetchMapaRele() {
    try {
        const resp = await fetch(mapaReleUrl);
        const mapa = await resp.json();
        let html = '<h3>Mapeamento Sensores → Relé Único</h3><table>';
        html += '<tr><th>Horta</th><th>Sensor</th><th>Relé</th></tr>';

        Object.entries(mapa).forEach(([horta, sensores]) => {
            const releUnico = horta === 'hortaA' ? 'RELE_A1' : 'RELE_B1';
            Object.keys(sensores).forEach(sensor => {
                html += `<tr><td>${horta}</td><td>${sensor}</td><td>${releUnico}</td></tr>`;
            });
        });
        html += '</table>';
        document.getElementById('mapaRele').innerHTML = html;
    } catch (error) {
        console.error("Erro ao carregar mapa de relé:", error);
        document.getElementById('mapaRele').innerHTML = "Mapa de relé não carregado.";
    }
  }

  function getCurrentDateTimeLocal() {
    const dt = new Date();
    dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
    return dt.toISOString().slice(0,16);
  }

  function getDateRangeForPeriod(period) {
    const now = new Date();
    let start, end = now;
    switch(period) {
      case '24h':
        start = new Date(now.getTime() - 24*60*60*1000);
        break;
      case '7d':
        start = new Date(now.getTime() - 7*24*60*60*1000);
        break;
      case '15d':
        start = new Date(now.getTime() - 15*24*60*60*1000);
        break;
      case '1m':
        start = new Date(now);
        start.setMonth(start.getMonth() - 1);
        break;
      case '3m':
        start = new Date(now);
        start.setMonth(start.getMonth() - 3);
        break;
      case 'year':
        start = new Date(now.getFullYear(), 0, 1);
        break;
      default:
        start = new Date(0);
    }
    return { start, end };
  }

  function updatePeriodInputs() {
    const period = document.getElementById('periodSelect').value;
    document.getElementById('customInputs').style.display = (period === 'custom') ? 'block' : 'none';
    if(period !== 'custom') {
      updateCharts();
    }
  }

  function calcularStatusRele(entries) {
    if(!configRele) return 'Configuração do relé não carregada';
    // Para simplificar, estamos considerando se a última leitura tem algum sensor abaixo do limiar
    // **NOTA: A lógica completa exigiria o parsing do sensor_umidade_01.log para obter o estado real do RELE_A1.**
    // Para fins de demonstração e com base nos dados disponíveis em hortaA/B (que não contêm RELE_ON/OFF),
    // a lógica de ativação baseada no limiar é mantida.
    if(!entries || entries.length === 0) return 'Sem dados';
    const limiar = configRele.umidade_ativacao;
    const ultimaLeitura = entries[entries.length - 1];
    
    // Verifica se *algum* sensor na última leitura está abaixo do limiar.
    const releAtivado = ultimaLeitura.valores.some(v => v < limiar);
    
    // Se você tivesse o log do relé:
    // if (logRele) { ... return logRele[logRele.length - 1].status === 'RELE_ON' ? 'Ligado' : 'Desligado'; }

    return releAtivado ? 'Ligado (última leitura abaixo de '+limiar+'%)' : 'Desligado (última leitura acima de '+limiar+'%)';
  }

  async function updateCharts() {
    if(!dataA || !dataB) return;
    const period = document.getElementById('periodSelect').value;
    let startDate, endDate = new Date();

    if(period === 'custom') {
      // Ajustar fuso horário para que o parse seja UTC-agnóstico (como a entrada local)
      startDate = new Date(document.getElementById('startDate').value);
      endDate = new Date(document.getElementById('endDate').value);
      
      if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
        alert("Informe datas corretas para o período personalizado.");
        return;
      }
    } else {
      const range = getDateRangeForPeriod(period);
      startDate = range.start;
      endDate = range.end;
    }

    const filteredA = filterEntries(dataA, startDate, endDate);
    const filteredB = filterEntries(dataB, startDate, endDate);

    const labelsA = formatLabels(filteredA);
    const labelsB = formatLabels(filteredB);

    const datasetsA = prepareDatasets(filteredA);
    const datasetsB = prepareDatasets(filteredB);

    desenharGraficoBarra('hortaAChart', labelsA, datasetsA, sensoresA);
    desenharGraficoBarra('hortaBChart', labelsB, datasetsB, sensoresB);

    document.getElementById('statusReleA').innerText = `Relé Horta A: ${calcularStatusRele(filteredA)}`;
    document.getElementById('statusReleB').innerText = `Relé Horta B: ${calcularStatusRele(filteredB)}`;
  }

  document.getElementById('periodSelect').addEventListener('change', updatePeriodInputs);

  async function main() {
    await fetchReleConfig();
    dataA = await fetchLogData(logAUrl);
    dataB = await fetchLogData(logBUrl);
    
    if (dataA.length === 0 || dataB.length === 0) {
        console.warn("Nenhum dado carregado para Horta A ou B. Verifique a URL e a estrutura do arquivo.");
    }
    
    const nowLocal = getCurrentDateTimeLocal();
    document.getElementById('startDate').value = nowLocal;
    document.getElementById('endDate').value = nowLocal;
    updatePeriodInputs();
    await fetchMapaRele();
  }

  main();
</script>

</body>
</html>