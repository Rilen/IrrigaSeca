<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Fileiras - Irrigação Sensor Único</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex; justify-content: center;
    }
    #container {
      max-width: 1200px; width: 100%;
    }
    h2 { text-align: center; }
    .graficos-fileira {
      margin-bottom: 50px;
      text-align: center;
    }
    .grafico-titulo {
      margin-bottom: 8px;
    }
    canvas {
      width: 70vw !important;
      max-width: 70vw !important;
      min-width: 400px;
      height: 400px !important;
      min-height: 400px !important;
      display: block;
      margin: 0 auto 30px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(150,150,150,0.08);
    }
  </style>
</head>
<body>
<div id="container">
  <h2>Monitoramento de Umidade por Fileira<br />Irrigação Automática • Sensor único a 20cm</h2>
  <div id="graficos"></div>
</div>
<script>
const fileiras = ["fileiraA", "fileiraB", "fileiraC", "fileiraD"];
const cores = ['blue','red','green','orange'];
const urls = fileiras.map(f => 
  `https://raw.githubusercontent.com/Rilen/IrrigaSeca/main/data/${f}.log`
);

// Busca o log e retorna { labels, umidade, eventos }
async function fetchFileiraLog(url) {
  const resp = await fetch(url);
  const text = await resp.text();
  const linhas = text.trim().split('\n');
  const labels = [], umidade = [], eventos = [];
  linhas.forEach((linha, i) => {
    const partes = linha.split(';');
    if (partes.length >= 2) {
      labels.push(partes[0].trim());
      umidade.push(parseFloat(partes[1]));
      if (partes[2]) eventos.push({ x: i, status: partes[2].trim() });
    }
  });
  return { labels, umidade, eventos };
}

function plotFileira(canvasId, titulo, cor, labels, umidade, eventos) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  const eventData_ON = eventos.filter(e=>e.status==='RELE_ON').map(e=>({x: e.x, y: umidade[e.x]}));
  const eventData_OFF = eventos.filter(e=>e.status==='RELE_OFF').map(e=>({x: e.x, y: umidade[e.x]}));
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Umidade (%)',
          data: umidade,
          borderColor: cor,
          backgroundColor: cor,
          pointRadius: 2,
          fill: false,
          tension: 0.1
        },
        {
          type: 'scatter',
          label: 'RELE_ON',
          data: eventData_ON,
          borderColor: 'black',
          backgroundColor: 'magenta',
          pointRadius: 6,
          showLine: false,
        },
        {
          type: 'scatter',
          label: 'RELE_OFF',
          data: eventData_OFF,
          borderColor: 'black',
          backgroundColor: 'lime',
          pointStyle: 'rect',
          pointRadius: 6,
          showLine: false,
        }
      ]
    },
    options: {
      plugins: { legend: { display: true } },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Data/Hora' }, ticks: { maxRotation: 60, minRotation: 45, maxTicksLimit: 12 } },
        y: { min: 0, max: 40, title: { display: true, text: 'Umidade (%)' } }
      }
    }
  });
}

async function main() {
  const container = document.getElementById('graficos');
  for(let i=0; i<fileiras.length; i++) {
    const data = await fetchFileiraLog(urls[i]);
    const titulo = `Fileira ${String.fromCharCode(65+i)} (Sensor 20cm)`;
    const canvasId = `canvas_${fileiras[i]}`;
    const div = document.createElement('div');
    div.className = 'graficos-fileira';
    // Importante: canvas traz atributo height fixo para garantir altura no Chart.js
    div.innerHTML = `<div class="grafico-titulo"><b>${titulo}</b></div>
                     <canvas id="${canvasId}" height="400"></canvas>`;
    container.appendChild(div);
    plotFileira(canvasId, titulo, cores[i], data.labels, data.umidade, data.eventos);
  }
}

main();
</script>
</body>
</html>
