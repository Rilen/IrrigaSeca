<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IrrigaSeca</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<style>
  body{font:14px Arial;margin:0;background:#f5f5f5}
  #c{padding:10px;max-width:1200px;margin:auto}
  h2{text-align:center;margin:10px 0}
  .menu{display:flex;flex-direction:column;gap:15px;align-items:center}
  .menu div{width:100%;max-width:300px}
  canvas#graf{background:#fff;border-radius:8px;box-shadow:0 2px 8px #0002;height:280px;width:100%}
  #pred{margin-top:30px;padding-top:20px;border-top:2px solid #eee}
  .blc{background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;margin:10px 0}
  .tbl{width:100%;border-collapse:collapse}
  .tbl td{padding:8px;border-bottom:1px solid #eee}
  .tbl td:last-child{text-align:right;font-weight:bold}
  .alto{color:#d9534f}.medio{color:#f0ad4e}.baixo{color:#5cb85c}
  #map{height:320px;width:90vw;max-width:900px;margin:15px auto;border-radius:12px;border:1px solid #ccc}
  @keyframes fade{0%{opacity:0;transform:translate(-50%,20px)}20%,80%{opacity:1}100%{opacity:0;transform:translate(-50%,-20px)}}
  @media(min-width:768px){
    .menu{flex-direction:row;justify-content:center;flex-wrap:wrap}
    canvas#graf{height:450px}#map{height:420px}
    .blc{max-width:45%;display:inline-block;vertical-align:top;text-align:center}
  }
</style>
</head>
<body>
<div id="c">
  <h2>IrrigaSeca</h2>
  <div class="menu">
    <div><label>Ano:<select id="a"></select></label></div>
    <div><label>Mês:<select id="m">
      <option>janeiro</option><option>fevereiro</option><option>marco</option>
      <option>abril</option><option>maio</option><option>junho</option>
      <option>julho</option><option>agosto</option><option>setembro</option>
      <option>outubro</option><option value="novembro" selected>novembro</option>
      <option>dezembro</option>
    </select></label></div>
    <div><label>Período:<select id="p">
      <option value="24h">24h</option><option value="7d">7d</option><option value="15d">15d</option>
      <option value="30d">30d</option><option value="60d">60d</option><option value="90d">90d</option>
      <option value="all" selected>Tudo</option>
    </select></label></div>
  </div>
  <canvas id="graf"></canvas>

  <div id="pred">
    <h2>Previsão 48h</h2>
    <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center">
      <div class="blc"><h3>Próximas 48h</h3><table class="tbl" id="tbl"></table></div>
      <div class="blc"><h3>Mapa de Calor</h3><div id="map"></div></div>
    </div>
  </div>
</div>

<script>
const files=["fileiraA","fileiraB","fileiraC","fileiraD"];
const cores=['#00f','#f00','#0f0','#fa0'];
const MAX=500;
let chart=null,trend=null,linha=null,mapa=null,th=null;
const cache={};

const els={a:document.getElementById('a'),m:document.getElementById('m'),p:document.getElementById('p'),
           ctx:document.getElementById('graf').getContext('2d')};

for(let y=2022;y<=2027;y++) els.a.add(new Option(y,y));
els.a.value=2025;

const url=f=>`./data/${f}_${els.m.value}_${els.a.value}.log`;

const load=async f=>{
  const u=url(f); if(cache[u]) return cache[u];
  const r=await fetch(u,{cache:"force-cache"});
  if(!r?.ok) return {l:[],d:[]};
  const t=await r.text();
  const l=[],d=[];
  t.trim().split('\n').forEach(x=>{const [ts,v]=x.split(';'); if(ts?.startsWith('202')){l.push(ts);d.push(+v);}});
  return cache[u]={l,d};
};

const cuts={'24h':24,'7d':168,'15d':360,'30d':720,'60d':1440,'90d':2160};
const range=(len,p)=> p in cuts ? [Math.max(0,len-cuts[p]),len] : [0,len];

const sample=(a,len)=>len>MAX ? a.filter((_,i)=>i%Math.ceil(len/MAX)===0) : a;

const realUpd=async()=>{
  let L=[],DS=[],mx=0;
  for(const f of files){
    const {l,d}=await load(f);
    if(!l.length) continue;
    const [i,e]=range(l.length,els.p.value);
    const ls=l.slice(i,e), ds=sample(d.slice(i,e),e-i);
    if(ls.length>mx){mx=ls.length;L=ls;}
    DS.push({label:f,data:ds,borderColor:cores[files.indexOf(f)],tension:.1,pointRadius:2,fill:false});
  }
  const dias=els.p.value==='15d'?15:els.p.value==='30d'?30:els.p.value==='60d'?60:els.p.value==='90d'?90:els.p.value==='7d'?7:1;
  const step=mx?Math.ceil(mx/(12*dias)):1;

  chart?.destroy();
  chart=new Chart(els.ctx,{type:'line',data:{labels:L,datasets:DS},options:{
    responsive:true,maintainAspectRatio:true,animation:false,
    plugins:{legend:{display:true},zoom:{zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'xy'}}}},
    scales:{x:{ticks:{maxTicksLimit:12,stepSize:step}},y:{min:0,max:100,title:{display:true,text:'%'}}}
  }});

  tbl(); mapa?.remove(); map(); trend?.destroy(); linha?.destroy(); makeTrend(); makeLinha(); alertas();
};

const upd=()=>{clearTimeout(th);th=setTimeout(realUpd,150);};

const tbl=()=>{
  const t=document.getElementById('tbl');
  const r=[{f:'A',p:65},{f:'B',p:10},{f:'C',p:5},{f:'D',p:42}];
  t.innerHTML=r.map(x=>`<tr><td>Fileira ${x.f}</td><td class="${x.p<18?'alto':x.p<30?'medio':'baixo'}">${x.p}% (48h)</td></tr>`).join('');
  document.querySelector('#pred h2').textContent=`Previsão 48h • ${new Date(Date.now()+48*36e5).toLocaleString('pt-BR',{dateStyle:'short',timeStyle:'short'})}`;
};

const map=()=>{
  mapa=L.map('map',{zoomControl:false}).setView([-23.55,-46.63],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
  L.heatLayer([[-23.548,-46.635,0.2],[-23.549,-46.630,0.2],[-23.552,-46.632,1],[-23.551,-46.637,0.6]],
    {radius:25,blur:15,gradient:{0.2:'green',0.6:'yellow',1:'red'}}).addTo(mapa);
  setTimeout(()=>mapa.invalidateSize(),150);
};

const makeTrend=()=>{
  let c=document.getElementById('trend');
  if(!c){c=document.createElement('canvas');c.id='trend';c.height=180;c.style='width:90vw;max-width:900px;margin:20px auto;display:block';document.querySelector('#pred > div').appendChild(c);}
  const vals=files.map(f=>{const d=cache[url(f)];return d?d.d.slice(-24).reduce((a,b)=>a+b,0)/24:50;});
  trend?.destroy();
  trend=new Chart(c.getContext('2d'),{type:'bar',data:{labels:['A','B','C','D'],datasets:[{label:'24h',data:vals,backgroundColor:vals.map(v=>v<18?'#d9534f':v<30?'#f0ad4e':'#5cb85c')}]},options:{animation:false,plugins:{legend:{display:false},zoom:{zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'xy'}}}},scales:{y:{min:0,max:100}}}});
};

const makeLinha=()=>{
  let c=document.getElementById('linha');
  if(!c){c=document.createElement('canvas');c.id='linha';c.height=200;c.style='width:90vw;max-width:900px;margin:20px auto;display:block';document.querySelector('#pred > div').appendChild(c);}
  const labels=[], sets=[[], [], [], []];
  files.forEach((f,i)=>{const d=cache[url(f)];if(d){d.l.slice(-48).forEach(t=>labels.push(t.slice(11,16)));d.d.slice(-48).forEach(v=>sets[i].push(v));}});
  linha?.destroy();
  linha=new Chart(c.getContext('2d'),{type:'line',data:{labels,datasets:files.map((f,i)=>({label:f.slice(-1),data:sets[i],borderColor:cores[i]}))},options:{animation:false,plugins:{legend:{position:'top'},zoom:{zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'xy'}}}},scales:{y:{min:0,max:100}}}});
};

const alertas=()=>{
  const div=document.createElement('div');
  div.style=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
             background:#222;color:#fff;padding:12px 24px;border-radius:50px;
             box-shadow:0 4px 20px #0008;z-index:999;font-weight:bold;
             animation:fade 3.5s forwards;`;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),3500);
  const secos=files.flatMap(f=>{const d=cache[url(f)];return d&&d.d.length&&d.d.at(-1)<18?[{f:f.slice(-1),v:d.d.at(-1)}]:[]});
  div.textContent=secos.length?`⚠️ IRRIGUE: ${secos.map(x=>x.f).join(', ')} (${secos[0].v.toFixed(1)}%)`:'✅ Umidade OK';
  div.style.background=secos.length?'#d9534f':'#5cb85c';
};

[els.a,els.m,els.p].forEach(el=>el.onclick=upd);
upd();
</script>
</body>
</html>
