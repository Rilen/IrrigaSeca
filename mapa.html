<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrrigaSeca - Mapa de Calor Preditivo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhpmA9n58ZUXLA+H6sbAYOW/sXRJekTwnP8A="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
        h1 { text-align: center; }
        /* 3. Definir uma altura para o container do mapa */
        #mapaCalor { 
            height: 600px; 
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <h1>IrrigaSeca - Mapa de Calor de Umidade (Simulação)</h1>
    
    <div id="mapaCalor"></div>

    <script>
        // --- 5. PREPARAÇÃO DOS DADOS (Simulação) ---
        // Dados fictícios de 21 sensores
        // (lat, lon, id, umidade_atual)
        const dadosSensores = [
            // Fileira A (7 Sensores)
            { lat: -22.500, lon: -44.500, id: "A1", umidade: 14 }, // <-- SECO
            { lat: -22.500, lon: -44.502, id: "A2", umidade: 18 },
            { lat: -22.500, lon: -44.504, id: "A3", umidade: 25 },
            { lat: -22.500, lon: -44.506, id: "A4", umidade: 28 },
            { lat: -22.500, lon: -44.508, id: "A5", umidade: 26 },
            { lat: -22.500, lon: -44.510, id: "A6", umidade: 22 },
            { lat: -22.500, lon: -44.512, id: "A7", umidade: 20 },
            
            // Fileira B (7 Sensores)
            { lat: -22.502, lon: -44.500, id: "B1", umidade: 35 },
            { lat: -22.502, lon: -44.502, id: "B2", umidade: 38 },
            { lat: -22.502, lon: -44.504, id: "B3", umidade: 40 },
            { lat: -22.502, lon: -44.506, id: "B4", umidade: 37 },
            { lat: -22.502, lon: -44.508, id: "B5", umidade: 33 },
            { lat: -22.502, lon: -44.510, id: "B6", umidade: 35 },
            { lat: -22.502, lon: -44.512, id: "B7", umidade: 30 },

            // Fileira C (7 Sensores)
            { lat: -22.504, lon: -44.500, id: "C1", umidade: 12 }, // <-- SECO
            { lat: -22.504, lon: -44.502, id: "C2", umidade: 10 }, // <-- SECO
            { lat: -22.504, lon: -44.504, id: "C3", umidade: 14 }, // <-- SECO
            { lat: -22.504, lon: -44.506, id: "C4", umidade: 19 },
            { lat: -22.504, lon: -44.508, id: "C5", umidade: 22 },
            { lat: -22.504, lon: -44.510, id: "C6", umidade: 20 },
            { lat: -22.504, lon: -44.512, id: "C7", umidade: 18 }
        ];

        // --- 6. INICIALIZAÇÃO DO MAPA ---
        
        // Coordenadas centrais (Ex: uma fazenda) e Nível de Zoom
        const centroMapa = [-22.502, -44.506];
        const zoomLevel = 17; // Zoom alto para ver a fazenda

        // Inicializa o mapa na <div> "mapaCalor"
        var map = L.map('mapaCalor').setView(centroMapa, zoomLevel);

        // Adiciona a camada de mapa base (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);


        // --- 7. CAMADA DE MAPA DE CALOR (HEATMAP) ---

        // Converte dados dos sensores para o formato [lat, lon, intensidade]
        // Lógica: Quanto MENOR a umidade, MAIOR a intensidade (risco).
        const pontosCalor = dadosSensores.map(sensor => {
            // Mapeia a umidade (ex: 0-40) para uma intensidade (ex: 1.0 - 0.1)
            // Se umidade for 10 (muito seco), intensidade é 1.0 (máxima)
            // Se umidade for 40 (muito úmido), intensidade é 0.1 (mínima)
            
            let intensidade = 1.0 - (sensor.umidade / 40);
            if (intensidade < 0.1) intensidade = 0.1;
            if (intensidade > 1.0) intensidade = 1.0;
            
            return [sensor.lat, sensor.lon, intensidade];
        });

        // Adiciona a camada de calor ao mapa
        var heatLayer = L.heatLayer(pontosCalor, {
            radius: 35,      // Raio de influência de cada ponto
            blur: 25,        // Nível de "borrão" para suavizar
            maxZoom: 18,     // Zoom máximo que o heatmap atualiza
            gradient: {      // Define as cores
                0.1: 'green',  // 0.1 (Úmido/Baixo Risco) = Verde
                0.5: 'yellow', // 0.5 (Médio Risco) = Amarelo
                1.0: 'red'     // 1.0 (Seco/Alto Risco) = Vermelho
            }
        }).addTo(map);


        // --- 8. (OPCIONAL) MARCADORES DOS SENSORES ---
        
        // Adiciona marcadores para que se possa clicar em cada sensor
        dadosSensores.forEach(sensor => {
            let corIcone = 'green';
            if (sensor.umidade < 15) {
                corIcone = 'red';
            } else if (sensor.umidade < 20) {
                corIcone = 'orange';
            }

            // Cria um ícone simples (círculo)
            var iconeSensor = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:${corIcone}; width:10px; height:10px; border-radius:50%; border: 1px solid #fff;'></div>`,
                iconSize: [10, 10],
                iconAnchor: [5, 5]
            });

            L.marker([sensor.lat, sensor.lon], { icon: iconeSensor })
                .addTo(map)
                .bindPopup(`<b>Sensor ${sensor.id}</b><br>Umidade: ${sensor.umidade}%`);
        });

    </script>
</body>
</html>